{% extends 'base.html' %}
{% block content %}

<h1>Asistencias</h1>

<div class="form-container">
  <form action="{{ url_for('asistencias.agregar_ausencia') }}" method="POST">

    <label for="id_empleado">Empleado:</label>
    <select name="id_empleado" required>
      <option value="">-- Seleccionar Empleado --</option>
      {% for emp in empleados %}
        <option value="{{ emp.id_empleado }}">{{ emp.nombre_completo }}</option>
      {% endfor %}
    </select>

    <input type="text" name="tipo" placeholder="Tipo (Vacaciones, Permiso...)" required>

    <input type="date" name="fecha_inicio" id="new_inicio" required onchange="validarNuevaFecha()">
    <input type="date" name="fecha_fin" id="new_fin" required onchange="validarNuevaFecha()">

    <input type="text" name="motivo" placeholder="Motivo" required>

    <button type="submit">Registrar ausencia</button>
  </form>
</div>


<h2>Ausencias registradas</h2>
<table>
    <tr>
        <th>ID</th>
        <th>Empleado</th>
        <th>Tipo</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Motivo</th>
        <th>Acciones</th>
    </tr>

    {% for a in ausencias %}
    <tr>
        <td>{{ a.id_ausencia }}</td>
        <td>{{ a.nombre_completo }}</td>
        <td>{{ a.tipo }}</td>
        <td>{{ a.fecha_inicio }}</td>
        <td>{{ a.fecha_fin }}</td>
        <td>{{ a.motivo }}</td>

        <td>
            <button onclick="openModal({{ a.id_ausencia }})">Editar</button>

            <form action="{{ url_for('asistencias.eliminar_ausencia', id_ausencia=a.id_ausencia) }}"
                  method="POST" style="display:inline;">
                <button onclick="return confirm('Â¿Eliminar ausencia?')">Eliminar</button>
            </form>
        </td>
    </tr>

    <!-- MODAL -->
    <div id="overlay-{{ a.id_ausencia }}" class="modal-overlay" style="display:none;"
         onclick="closeModal({{ a.id_ausencia }})"></div>

    <div id="modal-{{ a.id_ausencia }}" class="edit-modal" style="display:none;">
        <h3>Editar Ausencia</h3>
        <form action="{{ url_for('asistencias.editar_ausencia', id_ausencia=a.id_ausencia) }}" method="POST">

            <label>Empleado:</label>
            <select name="id_empleado">
              {% for emp in empleados %}
                <option value="{{ emp.id_empleado }}"
                    {% if emp.id_empleado == a.id_empleado %} selected {% endif %}>
                  {{ emp.nombre_completo }}
                </option>
              {% endfor %}
            </select>

            <label>Tipo:</label>
            <input type="text" name="tipo" value="{{ a.tipo }}">

            <label>Fecha inicio:</label>
            <input type="date" name="fecha_inicio" id="edit_inicio_{{ a.id_ausencia }}"
                   value="{{ a.fecha_inicio }}" onchange="validarEditFecha({{ a.id_ausencia }})">

            <label>Fecha fin:</label>
            <input type="date" name="fecha_fin" id="edit_fin_{{ a.id_ausencia }}"
                   value="{{ a.fecha_fin }}" onchange="validarEditFecha({{ a.id_ausencia }})">

            <label>Motivo:</label>
            <input type="text" name="motivo" value="{{ a.motivo }}">

            <button type="submit">Actualizar</button>
            <button type="button" onclick="closeModal({{ a.id_ausencia }})">Cancelar</button>
        </form>
    </div>

    {% endfor %}
</table>


<script>
function openModal(id){
  document.getElementById("overlay-" + id).style.display = "block";
  document.getElementById("modal-" + id).style.display = "block";
}
function closeModal(id){
  document.getElementById("overlay-" + id).style.display = "none";
  document.getElementById("modal-" + id).style.display = "none";
}

function validarNuevaFecha(){
    let ini = document.getElementById("new_inicio").value;
    let fin = document.getElementById("new_fin").value;

    if (ini && fin && ini > fin){
        alert("La fecha de inicio NO puede ser mayor a la fecha final.");
        document.getElementById("new_fin").value = "";
    }
}

function validarEditFecha(id){
    let ini = document.getElementById("edit_inicio_" + id).value;
    let fin = document.getElementById("edit_fin_" + id).value;

    if (ini && fin && ini > fin){
        alert("La fecha de inicio NO puede ser mayor a la fecha final.");
        document.getElementById("edit_fin_" + id).value = "";
    }
}
</script>

{% endblock %}
