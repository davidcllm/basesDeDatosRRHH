<!-- Este archivo fue creado con ayuda de la Inteligencia Artificial de OpenAI. 
OpenAI. (2025). ChatGPT [Modelo de lenguaje de gran tamaño]. https://chat.openai.com/chat -->

{% extends "base.html" %}
{% block content %}
{% if current_role == 'invitado' %}
<!-- Mensaje (estilo similar a los flash) -->
<div
  style="max-width:600px;margin:60px auto;padding:16px;border-radius:8px;background:rgba(255,243,205,0.9);border:1px solid #ffe08a;color:#7a5a00;text-align:center;">
  Espera a que el administrador te otorgue permisos.
</div>
{% else %}
<h1>Gestión de Empleados</h1>

<div class="form-container">
  <form action="{{ url_for('empleados.agregar_empleado') }}" method="POST" onsubmit="return validateDates(this)">
    <input type="text" name="nombre" placeholder="Nombre" required
      oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúñÑ\s]/g, '')">
    <input type="text" name="apellido" placeholder="Apellido" required
      oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúñÑ\s]/g, '')">
    <input type="text" name="direccion" placeholder="Dirección" required>
    <input type="text" name="telefono" placeholder="Teléfono" required
      oninput="this.value = this.value.replace(/[^0-9\s]/g, '')">

    <label>Fecha Nacimiento:</label>
    <input type="date" name="fecha_nacimiento" placeholder="Fecha Nacimiento" required>

    <input type="text" name="cargo" placeholder="Cargo" required>
    <label>Fecha Contratación:</label>
    <input type="date" name="fecha_contratacion" placeholder="Fecha Contratación">
    <label>Historial Laboral:</label>
    <textarea name="historial_laboral" placeholder="Historial Laboral"></textarea>

    <!-- Cuenta Bancaria Dropdown -->
    <select name="id_cuenta_bancaria" required>
      <option value="">-- Cuenta Bancaria --</option>
      {% for c in cuentas_bancarias %}
      <option value="{{ c.id_cuenta_bancaria }}">{{ c.numero_cuenta }}</option>
      {% endfor %}
    </select>

    <select name="id_plan_carrera" required>
      <option value="">-- Plan Carrera --</option>
      {% for p in planes_carrera %}
      <option value="{{ p.id_plan_carrera }}">{{ p.objetivo }}</option>
      {% endfor %}
    </select>

    <select name="id_departamento" required>
      <option value="">-- Departamento --</option>
      {% for d in departamentos %}
      <option value="{{ d.id_departamento }}">{{ d.nombre }}</option>
      {% endfor %}
    </select>

    <button type="submit">Agregar Empleado</button>
  </form>
</div>

<h2 style="margin-top:40px;">Registros de Empleados</h2>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-empleados" class="btn btn-primary" onclick="toggleEmpleados()"
    style="padding:8px 16px;border-radius:6px;">▼ Cargar Empleados</button>
  <input type="text" id="search-empleados" placeholder="Buscar en empleados..." onkeyup="filterEmpleadosTable()"
    style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="empleados-container" style="display:none;">

  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre Completo</th>
        <th>Dirección</th>
        <th>Teléfono</th>
        <th>Fecha Nacimiento</th>
        <th>Cargo</th>
        <th>Fecha Contratación</th>
        <th>Historial Laboral</th>
        <th>Objetivo Plan Carrera</th>
        <th>Cuenta Bancaria</th>
        <th>Departamento</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody id="empleados-tbody">
      {% for e in empleados %}
      <tr id="row-{{ e.id_empleado }}">
        <td>{{ e.id_empleado }}</td>
        <td>{{ e.nombre_completo }}</td>
        <td>{{ e.direccion }}</td>
        <td>{{ e.telefono }}</td>
        <td>{{ e.fecha_nacimiento }}</td>
        <td>{{ e.cargo }}</td>
        <td>{{ e.fecha_contratacion }}</td>
        <td>{{ e.historial_laboral }}</td>
        <td>{{ e.plan_carrera_objetivo or 'Sin asignar' }}</td>
        <td>{{ e.cuenta_banco or 'Sin asignar' }}</td>
        <td>{{ e.departamento_nombre or 'Sin asignar' }}</td>

        <td style="width:220px;">
          <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
            <button type="button" class="btn btn-link" onclick="openEditModal('{{ e.id_empleado }}')"
              style="padding:0 8px;">Editar</button>
            <button type="button" class="btn btn-primary"
              style="background:#007bff;border-color:#007bff;padding:6px 18px;border-radius:6px;color:#fff;"
              onclick="eliminarEmpleado('{{ e.id_empleado }}')">Eliminar</button>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="12" style="text-align:center;">No hay empleados registrados.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modals outside the table -->
{% for e in empleados %}
<div id="overlay-empleado-{{ e.id_empleado }}" class="modal-overlay"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:999;"
  onclick="closeEditModal('{{ e.id_empleado }}')"></div>

<div id="modal-empleado-{{ e.id_empleado }}" class="edit-modal"
  style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:600px;background:#fff;border-radius:8px;padding:22px;z-index:1000;max-height:90vh;overflow-y:auto;box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
  <h3 style="margin-top:0;margin-bottom:20px;color:#333;">Editar Empleado</h3>
  <form action="{{ url_for('empleados.editar_empleado', id=e.id_empleado) }}" method="POST"
    onsubmit="return validateDates(this)">

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
      <!-- Nombre y Apellido -->
      {% set parts = e.nombre_completo.split(' ', 1) %}
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Nombre</label>
        <input type="text" name="nombre" value="{{ parts[0] }}" required
          oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúñÑ\s]/g, '')"
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Apellido</label>
        <input type="text" name="apellido" value="{{ parts[1] if parts|length > 1 else '' }}" required
          oninput="this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúñÑ\s]/g, '')"
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>

      <!-- Dirección y Teléfono -->
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Dirección</label>
        <input type="text" name="direccion" value="{{ e.direccion }}" required
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Teléfono</label>
        <input type="text" name="telefono" value="{{ e.telefono }}" required
          oninput="this.value = this.value.replace(/[^0-9\s]/g, '')"
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>

      <!-- Fecha Nacimiento y Cargo -->
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Fecha Nacimiento</label>
        <input type="date" name="fecha_nacimiento" value="{{ e.fecha_nacimiento }}" required
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Cargo</label>
        <input type="text" name="cargo" value="{{ e.cargo }}" required
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>

      <!-- Fecha Contratación -->
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Fecha Contratación</label>
        <input type="date" name="fecha_contratacion" value="{{ e.fecha_contratacion }}"
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      </div>

      <!-- Dropdowns -->
      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Cuenta Bancaria</label>
        <select name="id_cuenta_bancaria" required
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
          <option value="">-- Seleccionar --</option>
          {% for c in cuentas_bancarias %}
          <option value="{{ c.id_cuenta_bancaria }}" {% if e.id_cuenta_bancaria==c.id_cuenta_bancaria %}selected{% endif
            %}>{{ c.numero_cuenta }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Plan Carrera</label>
        <select name="id_plan_carrera" required
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
          <option value="">-- Seleccionar --</option>
          {% for p in planes_carrera %}
          <option value="{{ p.id_plan_carrera }}" {% if e.id_plan_carrera==p.id_plan_carrera %}selected{% endif %}>{{
            p.objetivo }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Departamento</label>
        <select name="id_departamento" required
          style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
          <option value="">-- Seleccionar --</option>
          {% for d in departamentos %}
          <option value="{{ d.id_departamento }}" {% if e.id_departamento==d.id_departamento %}selected{% endif %}>{{
            d.nombre }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Historial Laboral - Full width -->
    <div class="form-group" style="margin-top:15px;">
      <label style="display:block;margin-bottom:5px;font-weight:bold;color:#555;">Historial Laboral</label>
      <textarea name="historial_laboral" rows="3"
        style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;resize:vertical;font-family:inherit;">{{ e.historial_laboral }}</textarea>
    </div>

    <div style="display:flex;gap:10px;margin-top:20px;">
      <button type="submit" class="btn"
        style="flex:1;background:#0069ff;color:#fff;padding:10px;border-radius:6px;border:0;cursor:pointer;font-weight:bold;">Actualizar</button>
      <button type="button" class="btn"
        style="flex:1;background:#e9ecef;color:#333;padding:10px;border-radius:6px;border:0;cursor:pointer;font-weight:bold;"
        onclick="closeEditModal('{{ e.id_empleado }}')">Cancelar</button>
    </div>
  </form>
</div>
{% endfor %}

<!-- Custom Notification Modal -->
<div id="notification-modal"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center;">
  <div
    style="background:#fff;padding:24px;border-radius:12px;width:90%;max-width:400px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.2);">
    <h3 id="notification-title" style="margin-top:0;color:#333;">Notificación</h3>
    <p id="notification-message" style="color:#666;margin:16px 0;">Mensaje aquí</p>
    <button onclick="closeNotificationModal()"
      style="background:#007bff;color:#fff;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:bold;">Aceptar</button>
  </div>
</div>

<script>
  function openEditModal(id) {
    document.getElementById('overlay-empleado-' + id).style.display = 'block';
    document.getElementById('modal-empleado-' + id).style.display = 'block';
  }
  function closeEditModal(id) {
    document.getElementById('overlay-empleado-' + id).style.display = 'none';
    document.getElementById('modal-empleado-' + id).style.display = 'none';
  }

  function showNotification(message, isError = false) {
    const modal = document.getElementById('notification-modal');
    const title = document.getElementById('notification-title');
    const msg = document.getElementById('notification-message');

    title.innerText = isError ? 'Error' : 'Éxito';
    title.style.color = isError ? '#dc3545' : '#28a745';
    msg.innerHTML = message;

    modal.style.display = 'flex';
  }

  function closeNotificationModal() {
    document.getElementById('notification-modal').style.display = 'none';
  }

  function eliminarEmpleado(id) {
    if (!confirm('¿Estás seguro de que deseas eliminar este empleado?')) {
      return;
    }

    fetch(`/empleados/eliminar/${id}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(response => response.json().then(data => ({ status: response.status, body: data })))
      .then(result => {
        if (result.status === 200) {
          showNotification(result.body.message, false);
          document.querySelector('#notification-modal button').onclick = function () {
            window.location.reload();
          };
        } else {
          let message = result.body.message || 'Ocurrió un error al eliminar el empleado.';

          if (result.body.details && result.body.details.length > 0) {
            message += '<br><br><strong>Registros encontrados en:</strong><ul style="text-align:left;margin-top:8px;color:#555;">';
            result.body.details.forEach(item => {
              message += `<li>${item}</li>`;
            });
            message += '</ul>';
          }

          showNotification(message, true);
          document.querySelector('#notification-modal button').onclick = closeNotificationModal;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Error de conexión o del servidor.', true);
      });
  }
  function validateDates(form) {
    const fechaNacimiento = form.querySelector('[name="fecha_nacimiento"]').value;
    const fechaContratacion = form.querySelector('[name="fecha_contratacion"]').value;

    if (fechaNacimiento && fechaContratacion) {
      const nac = new Date(fechaNacimiento);
      const cont = new Date(fechaContratacion);

      if (cont <= nac) {
        showNotification('La fecha de contratación debe ser posterior a la fecha de nacimiento.', true);
        return false;
      }
    }
    return true;
  }

  // Toggle function for Empleados table
  function toggleEmpleados() {
    const container = document.getElementById('empleados-container');
    const btn = document.getElementById('toggle-empleados');
    const search = document.getElementById('search-empleados');

    if (container.style.display === 'none') {
      container.style.display = 'block';
      search.style.display = 'block';
      btn.textContent = '▲ Ocultar Empleados';
    } else {
      container.style.display = 'none';
      search.style.display = 'none';
      btn.textContent = '▼ Cargar Empleados';
    }
  }

  // Filter function for Empleados table
  function filterEmpleadosTable() {
    const searchInput = document.getElementById('search-empleados').value.toLowerCase();
    const rows = document.querySelectorAll('#empleados-tbody tr');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchInput) ? '' : 'none';
    });
  }
</script>
{% endif %}
{% endblock %}