{% extends "base.html" %}
{% block content %}

<h1>Módulo de Evaluación, Capacitación y Desarrollo</h1>

<!-- FORMULARIO AGREGAR EVALUACION -->
<div class="form-container" style="width:520px; margin: 20px auto;">
  <form action="{{ url_for('evaluacion.agregar_evaluacion') }}" method="POST"
    style="display:flex;flex-direction:column;gap:8px;">
    <h2 style="text-align:center; margin:0 0 12px 0;">Agregar Evaluación</h2>

    <label>Empleado:</label>
    <select name="id_empleado" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      <option value="">-- Seleccionar Empleado --</option>
      {% for emp in empleados %}
      <option value="{{ emp.id_empleado }}">{{ emp.nombre_completo }}</option>
      {% endfor %}
    </select>

    <label style="margin-top:0;">Fecha Evaluación:</label>
    <input type="datetime-local" name="fecha_evaluacion" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Tipo:</label>
    <input type="text" name="tipo" placeholder="Anual / Semestral..." required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Resultado:</label>
    <input type="text" name="resultado" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Observaciones:</label>
    <input type="text" name="observaciones"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Fecha Inicio:</label>
    <input type="datetime-local" name="fecha_inicio" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Fecha Fin:</label>
    <input type="datetime-local" name="fecha_fin" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:12px;">Agregar Evaluación</button>
  </form>
</div>

<!-- TABLA EVALUACIONES -->
<h2 style="margin-top:12px;">Evaluaciones de Desempeño</h2>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-evaluaciones" class="btn btn-primary" onclick="toggleEvaluaciones()"
    style="padding:8px 16px;border-radius:6px;">▼ Cargar Evaluaciones</button>
  <input type="text" id="search-evaluaciones" placeholder="Buscar en evaluaciones..."
    onkeyup="filterTable('evaluaciones')"
    style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="evaluaciones-container" style="display:none;">
  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>ID Empleado</th>
        <th>Nombre Empleado</th>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Resultado</th>
        <th>Observaciones</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="evaluaciones-tbody">
      <!-- Data cargada vía AJAX -->
    </tbody>
  </table>
</div>


<!-- FORMULARIO AGREGAR CAPACITACION -->
<div class="form-container" style="width:520px; margin: 20px auto;">
  <form action="{{ url_for('evaluacion.agregar_capacitacion') }}" method="POST"
    style="display:flex;flex-direction:column;gap:8px;">
    <h2 style="text-align:center; margin:0 0 12px 0;">Agregar Capacitación</h2>

    <label>Empleado:</label>
    <select name="id_empleado" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      <option value="">-- Seleccionar Empleado --</option>
      {% for emp in empleados %}
      <option value="{{ emp.id_empleado }}">{{ emp.nombre_completo }}</option>
      {% endfor %}
    </select>

    <label style="margin-top:0;">Curso:</label>
    <select name="id_capacitacion" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">
      <option value="">-- Seleccionar Curso --</option>
      {% for cap in capacitaciones_lista %}
      <option value="{{ cap.id_capacitacion }}">{{ cap.nombre }}</option>
      {% endfor %}
    </select>

    <label style="margin-top:0;">Fecha Inicio:</label>
    <input type="datetime-local" name="fecha_inicio" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Fecha Fin:</label>
    <input type="datetime-local" name="fecha_fin" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Resultado:</label>
    <input type="number" name="resultado" placeholder="0.00" step="0.01" min="0" max="100"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Comentarios:</label>
    <input type="text" name="comentarios"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:12px;">Agregar Capacitación</button>
  </form>
</div>


<!-- TABLA CAPACITACIONES -->
<h2 style="margin-top:12px;">Capacitaciones</h2>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-capacitaciones" class="btn btn-primary" onclick="toggleCapacitaciones()"
    style="padding:8px 16px;border-radius:6px;">▼ Cargar Capacitaciones</button>
  <input type="text" id="search-capacitaciones" placeholder="Buscar en capacitaciones..."
    onkeyup="filterTable('capacitaciones')"
    style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="capacitaciones-container" style="display:none;">
  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre Empleado</th>
        <th>Curso</th>
        <th>Descripción</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Proveedor</th>
        <th>Resultado</th>
        <th>Comentarios</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="capacitaciones-tbody">
      <!-- Data cargada vía AJAX -->
    </tbody>
  </table>
</div>


<!-- FORMULARIO AGREGAR PLAN DE CARRERA -->
<div class="form-container" style="width:520px; margin: 20px auto;">
  <form action="{{ url_for('evaluacion.agregar_plan_carrera') }}" method="POST"
    style="display:flex;flex-direction:column;gap:8px;">
    <h2 style="text-align:center; margin:0 0 12px 0;">Agregar Plan de Carrera</h2>

    <label style="margin-top:0;">Objetivo:</label>
    <input type="text" name="objetivo" placeholder="Ej: Desarrollador Senior" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Etapas:</label>
    <input type="text" name="etapas" placeholder="Ej: Junior-Mid-Senior" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Fecha Inicio:</label>
    <input type="datetime-local" name="fecha_inicio" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label style="margin-top:0;">Fecha Fin:</label>
    <input type="datetime-local" name="fecha_fin" required
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <button type="submit" class="btn btn-primary" style="width:100%; margin-top:12px;">Agregar Plan de Carrera</button>
  </form>
</div>


<!-- TABLA PLANES DE CARRERA -->
<h2 style="margin-top:18px;">Planes de Carrera</h2>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-planes" class="btn btn-primary" onclick="togglePlanes()"
    style="padding:8px 16px;border-radius:6px;">▼ Cargar Planes</button>
  <input type="text" id="search-planes" placeholder="Buscar en planes..." onkeyup="filterTable('planes')"
    style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="planes-container" style="display:none;">
  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre Empleado</th>
        <th>Objetivo</th>
        <th>Etapas</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="planes-tbody">
      <!-- Data cargada vía AJAX -->
    </tbody>
  </table>
</div>


<!-- Modals for Editing -->
<!-- Edit Evaluation Modal -->
<div id="edit-evaluacion-modal" class="modal"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:8px;width:500px;max-width:90%;">
    <h3>Editar Evaluación</h3>
    <form id="form-edit-evaluacion" method="POST">
      <input type="hidden" name="id_evaluacion" id="edit-eval-id">

      <label>Empleado:</label>
      <select name="id_empleado" id="edit-eval-empleado" required style="width:100%;padding:8px;margin-bottom:10px;">
        {% for emp in empleados %}
        <option value="{{ emp.id_empleado }}">{{ emp.nombre_completo }}</option>
        {% endfor %}
      </select>

      <label>Fecha Evaluación:</label>
      <input type="datetime-local" name="fecha_evaluacion" id="edit-eval-fecha" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Tipo:</label>
      <input type="text" name="tipo" id="edit-eval-tipo" required style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Resultado:</label>
      <input type="text" name="resultado" id="edit-eval-resultado" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Observaciones:</label>
      <input type="text" name="observaciones" id="edit-eval-observaciones"
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Fecha Inicio:</label>
      <input type="datetime-local" name="fecha_inicio" id="edit-eval-inicio" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Fecha Fin:</label>
      <input type="datetime-local" name="fecha_fin" id="edit-eval-fin" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" onclick="closeModal('edit-evaluacion-modal')" class="btn"
          style="background:#ccc;">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Capacitacion Modal -->
<div id="edit-capacitacion-modal" class="modal"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:8px;width:500px;max-width:90%;">
    <h3>Editar Capacitación</h3>
    <form id="form-edit-capacitacion" method="POST">
      <input type="hidden" name="id_empleado_capacitacion" id="edit-cap-id">

      <label>Empleado:</label>
      <select name="id_empleado" id="edit-cap-empleado" required style="width:100%;padding:8px;margin-bottom:10px;">
        {% for emp in empleados %}
        <option value="{{ emp.id_empleado }}">{{ emp.nombre_completo }}</option>
        {% endfor %}
      </select>

      <label>Fecha Inicio:</label>
      <input type="datetime-local" name="fecha_inicio" id="edit-cap-inicio" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Fecha Fin:</label>
      <input type="datetime-local" name="fecha_fin" id="edit-cap-fin" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Resultado:</label>
      <input type="number" name="resultado" id="edit-cap-resultado" step="0.01" min="0" max="100"
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Comentarios:</label>
      <input type="text" name="comentarios" id="edit-cap-comentarios"
        style="width:100%;padding:8px;margin-bottom:10px;">

      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" onclick="closeModal('edit-capacitacion-modal')" class="btn"
          style="background:#ccc;">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Plan Modal -->
<div id="edit-plan-modal" class="modal"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:8px;width:500px;max-width:90%;">
    <h3>Editar Plan de Carrera</h3>
    <form id="form-edit-plan" method="POST">
      <input type="hidden" name="id_plan_carrera" id="edit-plan-id">

      <label>Objetivo:</label>
      <input type="text" name="objetivo" id="edit-plan-objetivo" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Etapas:</label>
      <input type="text" name="etapas" id="edit-plan-etapas" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Fecha Inicio:</label>
      <input type="datetime-local" name="fecha_inicio" id="edit-plan-inicio" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <label>Fecha Fin:</label>
      <input type="datetime-local" name="fecha_fin" id="edit-plan-fin" required
        style="width:100%;padding:8px;margin-bottom:10px;">

      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" onclick="closeModal('edit-plan-modal')" class="btn"
          style="background:#ccc;">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>

<script>
  let evaluacionesLoaded = false;
  let capacitacionesLoaded = false;
  let planesLoaded = false;

  // --- EVALUACIONES ---
  function toggleEvaluaciones() {
    const container = document.getElementById('evaluaciones-container');
    const btn = document.getElementById('toggle-evaluaciones');
    const search = document.getElementById('search-evaluaciones');

    if (container.style.display === 'none') {
      if (!evaluacionesLoaded) {
        loadEvaluaciones();
        evaluacionesLoaded = true;
      }
      container.style.display = 'block';
      search.style.display = 'block';
      btn.textContent = '▲ Ocultar Evaluaciones';
    } else {
      container.style.display = 'none';
      search.style.display = 'none';
      btn.textContent = '▼ Cargar Evaluaciones';
    }
  }

  function loadEvaluaciones() {
    fetch('{{ url_for("evaluacion.get_evaluaciones") }}')
      .then(res => res.json())
      .then(data => renderEvaluaciones(data))
      .catch(err => console.error('Error loading evaluaciones:', err));
  }

  function renderEvaluaciones(data) {
    const tbody = document.getElementById('evaluaciones-tbody');
    tbody.innerHTML = '';
    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.id_evaluacion}</td>
        <td>${item.id_empleado || '-'}</td>
        <td>${item.nombre_completo || '-'}</td>
        <td>${formatDate(item.fecha_evaluacion)}</td>
        <td>${item.tipo}</td>
        <td>${item.resultado}</td>
        <td>${item.observaciones || ''}</td>
        <td>${formatDate(item.fecha_inicio)}</td>
        <td>${formatDate(item.fecha_fin)}</td>
        <td>
          <button class="btn btn-link" onclick='openEditEvaluacion(${JSON.stringify(item)})'>Editar</button>
          <form action="/evaluacion/eliminar_evaluacion/${item.id_evaluacion}" method="POST" style="display:inline;" onsubmit="return confirm(\'¿Eliminar evaluación?\');">
             <button type="submit" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">Eliminar</button>
          </form>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- CAPACITACIONES ---
  function toggleCapacitaciones() {
    const container = document.getElementById('capacitaciones-container');
    const btn = document.getElementById('toggle-capacitaciones');
    const search = document.getElementById('search-capacitaciones');

    if (container.style.display === 'none') {
      if (!capacitacionesLoaded) {
        loadCapacitaciones();
        capacitacionesLoaded = true;
      }
      container.style.display = 'block';
      search.style.display = 'block';
      btn.textContent = '▲ Ocultar Capacitaciones';
    } else {
      container.style.display = 'none';
      search.style.display = 'none';
      btn.textContent = '▼ Cargar Capacitaciones';
    }
  }

  function loadCapacitaciones() {
    fetch('{{ url_for("evaluacion.get_capacitaciones") }}')
      .then(res => res.json())
      .then(data => renderCapacitaciones(data))
      .catch(err => console.error('Error loading capacitaciones:', err));
  }

  function renderCapacitaciones(data) {
    const tbody = document.getElementById('capacitaciones-tbody');
    tbody.innerHTML = '';
    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item['id_empleado-capacitacion']}</td>
        <td>${item.nombre_completo}</td>
        <td>${item.nombre}</td>
        <td>${item.descripcion}</td>
        <td>${formatDate(item.fecha_inicio)}</td>
        <td>${formatDate(item.fecha_fin)}</td>
        <td>${item.proveedor}</td>
        <td>${item.resultado || '-'}</td>
        <td>${item.comentarios || ''}</td>
        <td>
          <button class="btn btn-link" onclick='openEditCapacitacion(${JSON.stringify(item)})'>Editar</button>
          <form action="/evaluacion/eliminar_capacitacion/${item['id_empleado-capacitacion']}" method="POST" style="display:inline;" onsubmit="return confirm(\'¿Eliminar capacitación?\');">
             <button type="submit" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">Eliminar</button>
          </form>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- PLANES ---
  function togglePlanes() {
    const container = document.getElementById('planes-container');
    const btn = document.getElementById('toggle-planes');
    const search = document.getElementById('search-planes');

    if (container.style.display === 'none') {
      if (!planesLoaded) {
        loadPlanes();
        planesLoaded = true;
      }
      container.style.display = 'block';
      search.style.display = 'block';
      btn.textContent = '▲ Ocultar Planes';
    } else {
      container.style.display = 'none';
      search.style.display = 'none';
      btn.textContent = '▼ Cargar Planes';
    }
  }

  function loadPlanes() {
    fetch('{{ url_for("evaluacion.get_planes_carrera") }}')
      .then(res => res.json())
      .then(data => renderPlanes(data))
      .catch(err => console.error('Error loading planes de carrera:', err));
  }

  function renderPlanes(data) {
    const tbody = document.getElementById('planes-tbody');
    tbody.innerHTML = '';
    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.id_plan_carrera}</td>
        <td>${item.nombre_completo || 'Sin asignar'}</td>
        <td>${item.objetivo}</td>
        <td>${item.etapas}</td>
        <td>${formatDate(item.fecha_inicio)}</td>
        <td>${formatDate(item.fecha_fin)}</td>
        <td>
          <button class="btn btn-link" onclick='openEditPlan(${JSON.stringify(item)})'>Editar</button>
          <form action="/evaluacion/eliminar_plan_carrera/${item.id_plan_carrera}" method="POST" style="display:inline;" onsubmit="return confirm(\'¿Eliminar plan?\');">
             <button type="submit" class="btn btn-danger" style="padding:4px 8px;font-size:12px;">Eliminar</button>
          </form>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- HELPERS ---
  function formatDate(dateString) {
    if (!dateString) return '';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return dateString;
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function toDatetimeLocal(dateString) {
    if (!dateString) return '';
    const d = new Date(dateString);
    if (isNaN(d.getTime())) return '';
    const pad = (n) => n < 10 ? '0' + n : n;
    return d.getFullYear() + '-' +
      pad(d.getMonth() + 1) + '-' +
      pad(d.getDate()) + 'T' +
      pad(d.getHours()) + ':' +
      pad(d.getMinutes());
  }

  function filterTable(type) {
    const searchInput = document.getElementById(`search-${type}`).value.toLowerCase();
    const rows = document.querySelectorAll(`#${type}-tbody tr`);
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchInput) ? '' : 'none';
    });
  }

  function closeModal(id) {
    document.getElementById(id).style.display = 'none';
  }

  // --- MODAL OPENERS ---
  function openEditEvaluacion(item) {
    document.getElementById('edit-eval-id').value = item.id_evaluacion;
    document.getElementById('edit-eval-empleado').value = item.id_empleado;
    document.getElementById('edit-eval-fecha').value = toDatetimeLocal(item.fecha_evaluacion);
    document.getElementById('edit-eval-tipo').value = item.tipo;
    document.getElementById('edit-eval-resultado').value = item.resultado;
    document.getElementById('edit-eval-observaciones').value = item.observaciones;
    document.getElementById('edit-eval-inicio').value = toDatetimeLocal(item.fecha_inicio);
    document.getElementById('edit-eval-fin').value = toDatetimeLocal(item.fecha_fin);

    document.getElementById('form-edit-evaluacion').action = `/evaluacion/editar_evaluacion/${item.id_evaluacion}`;
    document.getElementById('edit-evaluacion-modal').style.display = 'flex';
  }

  function openEditCapacitacion(item) {
    document.getElementById('edit-cap-id').value = item['id_empleado-capacitacion'];
    document.getElementById('edit-cap-empleado').value = item.id_empleado;
    document.getElementById('edit-cap-inicio').value = toDatetimeLocal(item.fecha_inicio);
    document.getElementById('edit-cap-fin').value = toDatetimeLocal(item.fecha_fin);
    document.getElementById('edit-cap-resultado').value = item.resultado;
    document.getElementById('edit-cap-comentarios').value = item.comentarios;

    document.getElementById('form-edit-capacitacion').action = `/evaluacion/editar_capacitacion/${item['id_empleado-capacitacion']}`;
    document.getElementById('edit-capacitacion-modal').style.display = 'flex';
  }

  function openEditPlan(item) {
    document.getElementById('edit-plan-id').value = item.id_plan_carrera;
    document.getElementById('edit-plan-objetivo').value = item.objetivo;
    document.getElementById('edit-plan-etapas').value = item.etapas;
    document.getElementById('edit-plan-inicio').value = toDatetimeLocal(item.fecha_inicio);
    document.getElementById('edit-plan-fin').value = toDatetimeLocal(item.fecha_fin);

    document.getElementById('form-edit-plan').action = `/evaluacion/editar_plan_carrera/${item.id_plan_carrera}`;
    document.getElementById('edit-plan-modal').style.display = 'flex';
  }
</script>
{% endblock %}