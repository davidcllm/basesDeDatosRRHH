{% extends "base.html" %}
{% block content %}
<h1>Módulo de Nómina y Compensaciones</h1>

<div class="form-container">
  <form action="{{ url_for('nomina.agregar_nomina') }}" method="POST">
    <label for="id_empleado">Empleado:</label>
    <select id="id_empleado" name="id_empleado" required>
      <option value="">-- Seleccionar Empleado --</option>
      {% for emp in empleados %}
      <option value="{{ emp.id_empleado }}">{{ emp.nombre_completo }}</option>
      {% endfor %}
    </select>

    <input type="number" name="salario_base" placeholder="Salario base" required step="0.01">
    <input type="number" name="deducciones" placeholder="Deducciones" required step="0.01">
    <input type="number" name="percepciones" placeholder="Percepciones" required step="0.01">

    <button type="submit" class="btn btn-primary" style="width:100%;margin-top:12px;">Agregar Datos</button>
  </form>
</div>

<table class="table" style="width:95%;margin:20px auto;">
  <thead>
    <tr>
      <th>ID nomina</th>
      <th>Empleado</th>
      <th>ID empleado</th>
      <th>Salario base</th>
      <th>Deducciones</th>
      <th>Percepciones</th>
      <th>Total a pagar</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for n in nomina %}
    <tr id="row-{{ n.id_nomina }}">
      <td>{{ n.id_nomina }}</td>
      <td>{{ n.nombre_completo }}</td>
      <td>{{ n.id_empleado }}</td>
      <td>{{ n.salario_base | currency }}</td>
      <td>{{ n.deducciones | currency }}</td>
      <td>{{ n.percepciones | currency }}</td>
      <td>{{ n.total_pagar | currency }}</td>
      <td style="width:220px;">
        <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
          <button type="button" class="btn btn-link" onclick="openEditModal({{ n.id_nomina }})"
            style="padding:0 8px;">Editar</button>
          <form action="{{ url_for('nomina.eliminar_nomina', id_nomina=n.id_nomina) }}" method="POST" style="margin:0;">
            <button type="submit" class="btn btn-primary"
              style="background:#007bff;border-color:#007bff;padding:6px 18px;border-radius:6px;color:#fff;"
              onclick="return confirm('Eliminar nómina?')">Eliminar</button>
          </form>
        </div>
      </td>
    </tr>

    <!-- Modal de edición (precargado por registro) -->
    <div id="overlay-nomina-{{ n.id_nomina }}" class="modal-overlay"
      style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:999;"
      onclick="closeEditModal({{ n.id_nomina }})"></div>

    <div id="modal-nomina-{{ n.id_nomina }}" class="edit-modal"
      style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:380px;background:#fff;border-radius:8px;padding:22px;z-index:1000;">
      <h3>Editar Nómina</h3>
      <form action="{{ url_for('nomina.editar_nomina', id_nomina=n.id_nomina) }}" method="POST">
        <!-- Mostrar empleado (no editable) -->
        <div class="form-group" style="margin-bottom:12px;">
          <label>Empleado</label>
          <div style="padding:8px 10px;border-radius:6px;border:1px solid #eee;background:#fafafa;">
            <strong>{{ n.nombre_completo }}</strong>
          </div>
        </div>

        <div class="form-group" style="margin-bottom:12px;">
          <label for="sal-{{ n.id_nomina }}">Salario base</label>
          <input id="sal-{{ n.id_nomina }}" name="salario_base" type="number" step="0.01" value="{{ n.salario_base }}"
            class="form-control" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;" required>
        </div>

        <div class="form-group" style="margin-bottom:12px;">
          <label for="ded-{{ n.id_nomina }}">Deducciones</label>
          <input id="ded-{{ n.id_nomina }}" name="deducciones" type="number" step="0.01" value="{{ n.deducciones }}"
            class="form-control" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;" required>
        </div>

        <div class="form-group" style="margin-bottom:12px;">
          <label for="perc-{{ n.id_nomina }}">Percepciones</label>
          <input id="perc-{{ n.id_nomina }}" name="percepciones" type="number" step="0.01" value="{{ n.percepciones }}"
            class="form-control" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;" required>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px;">
          <button type="submit" class="btn"
            style="flex:1;background:#0069ff;color:#fff;padding:10px;border-radius:6px;border:0;">Actualizar</button>
          <button type="button" class="btn"
            style="flex:1;background:#e9ecef;color:#333;padding:10px;border-radius:6px;border:0;"
            onclick="closeEditModal({{ n.id_nomina }})">Cancelar</button>
        </div>
      </form>
    </div>
    {% endfor %}
  </tbody>
</table>

<script>
  function openEditModal(id) {
    document.getElementById('overlay-nomina-' + id).style.display = 'block';
    document.getElementById('modal-nomina-' + id).style.display = 'block';
  }
  function closeEditModal(id) {
    document.getElementById('overlay-nomina-' + id).style.display = 'none';
    document.getElementById('modal-nomina-' + id).style.display = 'none';
  }
</script>
{% endblock %}