{% extends "base.html" %}
{% block content %}

<h1>Gestión de Proyectos</h1>

<!-- FORMULARIO CREAR PROYECTO (siempre visible) -->
<div class="form-container" style="width:520px; margin: 20px auto;">
  <h2>Crear Proyecto</h2>
  <form action="{{ url_for('proyectos.crear_proyecto') }}" method="POST" style="display:flex;flex-direction:column;gap:8px;" onsubmit="return validarCrearProyecto()">
    <label>Nombre del proyecto:</label>
    <input type="text" name="nombre" id="crear_nombre" placeholder="Proyecto Alpha" maxlength="45" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label>Descripción:</label>
    <textarea name="descripcion" id="crear_descripcion" placeholder="Descripción del proyecto..." rows="3" maxlength="145" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;"></textarea>

    <button type="submit" class="btn btn-primary" style="width:120px;margin-top:8px;">Guardar</button>
  </form>
</div>

<!-- MENSAJES FLASH -->

<h2>Proyectos registrados</h2>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-proyectos" class="btn btn-primary" onclick="toggleProyectos()" style="padding:8px 16px;border-radius:6px;">▼ Cargar Proyectos</button>
  <input type="text" id="search-proyectos" placeholder="Buscar proyectos..." onkeyup="filterTable('proyectos')" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="proyectos-container" style="display:none;">
  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Proyecto</th>
        <th>Descripción</th>
        <th style="text-align:right;">Acciones</th>
      </tr>
    </thead>
    <tbody id="proyectos-tbody">
      <!-- filas cargadas vía AJAX -->
    </tbody>
  </table>
</div>

<h2>Asignaciones de Proyectos</h2>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-asignaciones" class="btn btn-primary" onclick="toggleAsignaciones()" style="padding:8px 16px;border-radius:6px;">▼ Cargar Asignaciones</button>
  <input type="text" id="search-asignaciones" placeholder="Buscar asignaciones..." onkeyup="filterTable('asignaciones')" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="asignaciones-container" style="display:none;">
  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Empleado</th>
        <th>Proyecto</th>
        <th>Horas</th>
        <th>Asignación</th>
        <th>Entrega</th>
        <th style="text-align:right;">Acciones</th>
      </tr>
    </thead>
    <tbody id="asignaciones-tbody">
      <!-- filas cargadas vía AJAX -->
    </tbody>
  </table>
</div>

<!-- Agregar CRUD Departamentos (estilo consistente) -->
<h2>Departamentos</h2>

<!-- Form crear departamento (visible) -->
<div class="form-container" style="width:520px; margin: 20px auto;">
  <h3>Crear Departamento</h3>
  <form action="{{ url_for('proyectos.crear_departamento') }}" method="POST" onsubmit="return validarCrearDepartamento()" style="display:flex;flex-direction:column;gap:8px;">
    <label>Nombre:</label>
    <input type="text" name="nombre" id="crear_depart_nombre" maxlength="45" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;">

    <label>Descripción:</label>
    <textarea name="descripcion" id="crear_depart_descripcion" maxlength="145" required rows="3" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;"></textarea>

    <button type="submit" class="btn btn-primary" style="width:120px;margin-top:8px;">Crear</button>
  </form>
</div>

<div style="width:95%;margin:20px auto;display:flex;gap:10px;align-items:center;">
  <button type="button" id="toggle-departamentos" class="btn btn-primary" onclick="toggleDepartamentos()" style="padding:8px 16px;border-radius:6px;">▼ Cargar Departamentos</button>
  <input type="text" id="search-departamentos" placeholder="Buscar departamentos..." onkeyup="filterTable('departamentos')" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;display:none;">
</div>

<div id="departamentos-container" style="display:none;">
  <table class="table" style="width:95%;margin:20px auto;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Descripción</th>
        <th style="text-align:right;">Acciones</th>
      </tr>
    </thead>
    <tbody id="departamentos-tbody">
      <!-- filas cargadas vía AJAX -->
    </tbody>
  </table>
</div>

<!-- Contenedor para modales (fuera de la tabla) -->
<div id="modals-root"></div>

<script>
let proyectosData = [];
let empleadosData = [];
let proyectosLoaded = false;
let asignacionesData = [];
let asignacionesLoaded = false;
let departamentosData = [];
let departamentosLoaded = false;

/* reemplazar loadAsignaciones por esta versión que asegura cargas previas */
function loadAsignaciones(){
  const promises = [];

  // Si no hay proyectos cargados, traerlos
  if(!proyectosData || proyectosData.length === 0){
    promises.push(fetch('{{ url_for("proyectos.get_proyectos") }}').then(r => r.json()).then(d => proyectosData = d));
  } else {
    promises.push(Promise.resolve());
  }

  // Si no hay empleados cargados, traerlos
  if(!empleadosData || empleadosData.length === 0){
    promises.push(fetch('{{ url_for("proyectos.get_empleados") }}').then(r => r.json()).then(d => empleadosData = d));
  } else {
    promises.push(Promise.resolve());
  }

  // Siempre traer asignaciones
  promises.push(fetch('{{ url_for("proyectos.get_asignaciones") }}').then(r => r.json()));

  Promise.all(promises)
    .then(results => {
      // la última promesa es la de asignaciones (si usó Promise.resolve puede variar)
      const asignaciones = results[results.length - 1];
      asignacionesData = asignaciones || [];
      renderAsignaciones(asignacionesData);
    })
    .catch(e => console.error('Error cargando asignaciones/proyectos/empleados:', e));
}

/* en renderAsignaciones cambiar color del botón Eliminar a azul y asegurar selects */
function renderAsignaciones(data){
  const tbody = document.getElementById('asignaciones-tbody');
  const modalsRoot = document.getElementById('modals-root');
  tbody.innerHTML = '';
  // eliminar modales de asignaciones previos
  const prev = Array.from(modalsRoot.querySelectorAll('[id^="modal-asign-"], [id^="overlay-asign-"]'));
  prev.forEach(n => n.remove());

  data.forEach(a => {
    const deleteUrl = `/proyectos/asignacion/eliminar/${a.id}`;
    const updateUrl = `/proyectos/asignacion/actualizar/${a.id}`;

    const row = `
      <tr id="row-asign-${a.id}">
        <td>${a.id}</td>
        <td>${escapeHtml(a.empleado)}</td>
        <td>${escapeHtml(a.proyecto)}</td>
        <td>${a.horas_asignadas}</td>
        <td>${a.fecha_asignacion}</td>
        <td>${a.fecha_entrega}</td>
        <td style="text-align:right; width:240px;">
          <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
            <button type="button" class="btn btn-link" onclick="openModalAsignEdit(${a.id})" style="padding:0 8px;">Editar</button>
            <form action="${deleteUrl}" method="POST" style="margin:0;">
              <button type="submit" class="btn btn-primary" style="background:#007bff;border-color:#007bff;padding:6px 18px;border-radius:6px;color:#fff;" onclick="return confirm('¿Eliminar asignación?')">Eliminar</button>
            </form>
          </div>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);

    // construir options desde empleadosData y proyectosData (ya cargados)
    let empleadosOptions = '<option value="">Seleccione</option>';
    empleadosData.forEach(e => {
      empleadosOptions += `<option value="${e.id_empleado}">${escapeHtml(e.nombre_completo)}</option>`;
    });
    let proyectosOptions = '<option value="">Seleccione</option>';
    proyectosData.forEach(p => {
      proyectosOptions += `<option value="${p.id_proyecto}">${escapeHtml(p.nombre)}</option>`;
    });

    const modal = `
      <div id="overlay-asign-${a.id}" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:999;" onclick="closeModalAsignEdit(${a.id})"></div>
      <div id="modal-asign-${a.id}" class="edit-modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:460px;background:#fff;border-radius:8px;padding:22px;z-index:1000;">
        <h3>Editar Asignación</h3>
        <form action="${updateUrl}" method="POST" onsubmit="return validarEditarAsignacion(${a.id})">
          <label>Empleado:</label>
          <select name="id_empleado" id="edit_asign_empleado_${a.id}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
            ${empleadosOptions}
          </select>
          <label>Proyecto:</label>
          <select name="id_proyecto" id="edit_asign_proyecto_${a.id}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
            ${proyectosOptions}
          </select>
          <label>Horas asignadas:</label>
          <input type="number" name="horas_asignadas" id="edit_asign_horas_${a.id}" value="${a.horas_asignadas}" min="1" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <label>Fecha asignación:</label>
          <input type="date" name="fecha_asignacion" id="edit_asign_fecha_inicio_${a.id}" value="${a.fecha_asignacion}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <label>Fecha entrega:</label>
          <input type="date" name="fecha_entrega" id="edit_asign_fecha_fin_${a.id}" value="${a.fecha_entrega}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button type="submit" class="btn btn-primary" style="flex:1;">Actualizar</button>
            <button type="button" class="btn" style="flex:1;background:#e9ecef;color:#333;" onclick="closeModalAsignEdit(${a.id})">Cancelar</button>
          </div>
        </form>
      </div>
    `;
    modalsRoot.insertAdjacentHTML('beforeend', modal);

    // setear selects con los valores actuales (después de insertar en DOM)
    setTimeout(() => {
      const selE = document.getElementById(`edit_asign_empleado_${a.id}`);
      if(selE) selE.value = a.id_empleado;
      const selP = document.getElementById(`edit_asign_proyecto_${a.id}`);
      if(selP) selP.value = a.id_proyecto;
    }, 0);
  });
}

function toggleProyectos(){
  const container = document.getElementById('proyectos-container');
  const btn = document.getElementById('toggle-proyectos');
  const search = document.getElementById('search-proyectos');

  if(!proyectosLoaded){
    loadProyectos();
    proyectosLoaded = true;
  }

  if(container.style.display === 'none'){
    container.style.display = 'block';
    search.style.display = 'block';
    btn.textContent = '▲ Ocultar Proyectos';
  } else {
    container.style.display = 'none';
    search.style.display = 'none';
    btn.textContent = '▼ Cargar Proyectos';
  }
}

function loadProyectos(){
  // Usar Promise.all para esperar ambas peticiones
  Promise.all([
    fetch('{{ url_for("proyectos.get_proyectos") }}').then(r => r.json()),
    fetch('{{ url_for("proyectos.get_empleados") }}').then(r => r.json())
  ])
  .then(([proyectosResponse, empleadosResponse]) => {
    proyectosData = proyectosResponse;
    empleadosData = empleadosResponse;
    renderProyectos(proyectosData);
  })
  .catch(e => console.error('Error cargando datos:', e));
}

function renderProyectos(data){
  const tbody = document.getElementById('proyectos-tbody');
  const modalsRoot = document.getElementById('modals-root');
  tbody.innerHTML = '';
  modalsRoot.innerHTML = '';

  data.forEach(p => {
    const deleteUrl = `/proyectos/${p.id_proyecto}`;
    const editUrl = `/proyectos/actualizar/${p.id_proyecto}`;
    const assignUrl = `/proyectos/asignar`;

    // fila
    const row = `
      <tr id="row-${p.id_proyecto}">
        <td>${p.id_proyecto}</td>
        <td>${escapeHtml(p.nombre)}</td>
        <td>${escapeHtml(p.descripcion || '')}</td>
        <td style="text-align:right; width:320px;">
          <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
            <button type="button" class="btn btn-link" onclick="openModalEdit(${p.id_proyecto})" style="padding:0 8px;">Editar</button>

            <button type="button" class="btn btn-link" onclick="openModalAsignar(${p.id_proyecto})" style="padding:0 8px;">Asignar empleado</button>

            <form action="${deleteUrl}" method="POST" style="margin:0;">
              <button type="submit" class="btn btn-primary" style="background:#007bff;border-color:#007bff;padding:6px 18px;border-radius:6px;color:#fff;" onclick="return confirm('¿Eliminar proyecto?')">Eliminar</button>
            </form>
          </div>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);

    // modal editar (fuera de la tabla)
    const editModal = `
      <div id="overlay-edit-${p.id_proyecto}" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:999;" onclick="closeModalEdit(${p.id_proyecto})"></div>
      <div id="modal-edit-${p.id_proyecto}" class="edit-modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:480px;background:#fff;border-radius:8px;padding:22px;z-index:1000;">
        <h3>Editar Proyecto</h3>
        <form action="${editUrl}" method="POST" onsubmit="return validarEditarProyecto(${p.id_proyecto})">
          <label>Nombre:</label>
          <input type="text" name="nombre" value="${escapeAttr(p.nombre)}" maxlength="45" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;" id="edit_nombre_${p.id_proyecto}">
          <label>Descripción:</label>
          <textarea name="descripcion" maxlength="145" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;" id="edit_descripcion_${p.id_proyecto}">${escapeHtml(p.descripcion || '')}</textarea>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button type="submit" class="btn" style="flex:1;background:#0069ff;color:#fff;padding:10px;border-radius:6px;border:0;">Actualizar</button>
            <button type="button" class="btn" style="flex:1;background:#e9ecef;color:#333;padding:10px;border-radius:6px;border:0;" onclick="closeModalEdit(${p.id_proyecto})">Cancelar</button>
          </div>
        </form>
      </div>
    `;
    modalsRoot.insertAdjacentHTML('beforeend', editModal);

    // modal asignar empleado
    let empleadosOptions = '<option value="">Seleccione un empleado</option>';
    empleadosData.forEach(e => {
      empleadosOptions += `<option value="${e.id_empleado}">${escapeHtml(e.nombre_completo)}</option>`;
    });

    const asignModal = `
      <div id="overlay-assign-${p.id_proyecto}" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:999;" onclick="closeModalAsignar(${p.id_proyecto})"></div>
      <div id="modal-assign-${p.id_proyecto}" class="edit-modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:420px;background:#fff;border-radius:8px;padding:22px;z-index:1000;">
        <h3>Asignar empleado a: ${escapeHtml(p.nombre)}</h3>
        <form action="${assignUrl}" method="POST" onsubmit="return validarAsignar(${p.id_proyecto})">
          <input type="hidden" name="id_proyecto" value="${p.id_proyecto}">
          <label>Empleado:</label>
          <select name="id_empleado" id="assign_empleado_${p.id_proyecto}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
            ${empleadosOptions}
          </select>
          <label>Horas asignadas:</label>
          <input type="number" name="horas_asignadas" id="assign_horas_${p.id_proyecto}" min="1" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <label>Fecha asignación:</label>
          <input type="date" name="fecha_asignacion" id="assign_fecha_inicio_${p.id_proyecto}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <label>Fecha entrega:</label>
          <input type="date" name="fecha_entrega" id="assign_fecha_fin_${p.id_proyecto}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button type="submit" class="btn btn-primary" style="flex:1;">Asignar</button>
            <button type="button" class="btn" style="flex:1;background:#e9ecef;color:#333;" onclick="closeModalAsignar(${p.id_proyecto})">Cancelar</button>
          </div>
        </form>
      </div>
    `;
    modalsRoot.insertAdjacentHTML('beforeend', asignModal);
  });
}

function toggleAsignaciones(){
  const container = document.getElementById('asignaciones-container');
  const btn = document.getElementById('toggle-asignaciones');
  const search = document.getElementById('search-asignaciones');

  if(!asignacionesLoaded){
    loadAsignaciones();
    asignacionesLoaded = true;
  }

  if(container.style.display === 'none'){
    container.style.display = 'block';
    search.style.display = 'block';
    btn.textContent = '▲ Ocultar Asignaciones';
  } else {
    container.style.display = 'none';
    search.style.display = 'none';
    btn.textContent = '▼ Cargar Asignaciones';
  }
}

function toggleDepartamentos(){
  const container = document.getElementById('departamentos-container');
  const btn = document.getElementById('toggle-departamentos');
  const search = document.getElementById('search-departamentos');

  if(!departamentosLoaded){
    loadDepartamentos();
    departamentosLoaded = true;
  }

  if(container.style.display === 'none'){
    container.style.display = 'block';
    search.style.display = 'block';
    btn.textContent = '▲ Ocultar Departamentos';
  } else {
    container.style.display = 'none';
    search.style.display = 'none';
    btn.textContent = '▼ Cargar Departamentos';
  }
}

function loadDepartamentos(){
  fetch('{{ url_for("proyectos.get_departamentos") }}')
    .then(r => r.json())
    .then(data => {
      departamentosData = data;
      renderDepartamentos(data);
    })
    .catch(e => console.error('Error cargando departamentos:', e));
}

function renderDepartamentos(data){
  const tbody = document.getElementById('departamentos-tbody');
  const modalsRoot = document.getElementById('modals-root');
  tbody.innerHTML = '';
  // eliminar modales de departamentos previos
  const prev = Array.from(modalsRoot.querySelectorAll('[id^="modal-depart-"], [id^="overlay-depart-"]'));
  prev.forEach(n => n.remove());

  data.forEach(d => {
    const deleteUrl = `/departamentos/eliminar/${d.id_departamento}`;
    const updateUrl = `/departamentos/actualizar/${d.id_departamento}`;

    const row = `
      <tr id="row-depart-${d.id_departamento}">
        <td>${d.id_departamento}</td>
        <td>${escapeHtml(d.nombre)}</td>
        <td>${escapeHtml(d.descripcion)}</td>
        <td style="text-align:right; width:240px;">
          <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
            <button type="button" class="btn btn-link" onclick="openModalDepartEdit(${d.id_departamento})" style="padding:0 8px;">Editar</button>
            <form action="${deleteUrl}" method="POST" style="margin:0;">
              <button type="submit" class="btn btn-primary" style="background:#007bff;border-color:#007bff;padding:6px 18px;border-radius:6px;color:#fff;" onclick="return confirm('¿Eliminar departamento?')">Eliminar</button>
            </form>
          </div>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);

    const modal = `
      <div id="overlay-depart-${d.id_departamento}" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:999;" onclick="closeModalDepartEdit(${d.id_departamento})"></div>
      <div id="modal-depart-${d.id_departamento}" class="edit-modal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:460px;background:#fff;border-radius:8px;padding:22px;z-index:1000;">
        <h3>Editar Departamento</h3>
        <form action="${updateUrl}" method="POST" onsubmit="return validarEditarDepartamento(${d.id_departamento})">
          <label>Nombre:</label>
          <input type="text" name="nombre" id="edit_depart_nombre_${d.id_departamento}" value="${escapeAttr(d.nombre)}" maxlength="45" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">
          <label>Descripción:</label>
          <textarea name="descripcion" id="edit_depart_descripcion_${d.id_departamento}" maxlength="145" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;">${escapeHtml(d.descripcion)}</textarea>
          <div style="display:flex;gap:10px;margin-top:12px;">
            <button type="submit" class="btn btn-primary" style="flex:1;">Actualizar</button>
            <button type="button" class="btn" style="flex:1;background:#e9ecef;color:#333;" onclick="closeModalDepartEdit(${d.id_departamento})">Cancelar</button>
          </div>
        </form>
      </div>
    `;
    modalsRoot.insertAdjacentHTML('beforeend', modal);
  });
}

function openModalEdit(id){
  document.getElementById("overlay-edit-" + id).style.display = "block";
  document.getElementById("modal-edit-" + id).style.display = "block";
}
function closeModalEdit(id){
  document.getElementById("overlay-edit-" + id).style.display = "none";
  document.getElementById("modal-edit-" + id).style.display = "none";
}

function openModalAsignar(id){
  document.getElementById("overlay-assign-" + id).style.display = "block";
  document.getElementById("modal-assign-" + id).style.display = "block";
}
function closeModalAsignar(id){
  document.getElementById("overlay-assign-" + id).style.display = "none";
  document.getElementById("modal-assign-" + id).style.display = "none";
}

function openModalAsignEdit(id){
  document.getElementById("overlay-asign-" + id).style.display = "block";
  document.getElementById("modal-asign-" + id).style.display = "block";
}
function closeModalAsignEdit(id){
  document.getElementById("overlay-asign-" + id).style.display = "none";
  document.getElementById("modal-asign-" + id).style.display = "none";
}

function openModalDepartEdit(id){
  document.getElementById("overlay-depart-" + id).style.display = "block";
  document.getElementById("modal-depart-" + id).style.display = "block";
}
function closeModalDepartEdit(id){
  document.getElementById("overlay-depart-" + id).style.display = "none";
  document.getElementById("modal-depart-" + id).style.display = "none";
}

function validarCrearProyecto(){
  const nombre = document.getElementById("crear_nombre").value.trim();
  const descripcion = document.getElementById("crear_descripcion").value.trim();

  if(nombre.length === 0 || nombre.length > 45){
    alert("El nombre debe tener entre 1 y 45 caracteres.");
    return false;
  }

  if(descripcion.length === 0 || descripcion.length > 145){
    alert("La descripción debe tener entre 1 y 145 caracteres.");
    return false;
  }

  return true;
}

function validarEditarProyecto(id){
  const nombre = document.getElementById(`edit_nombre_${id}`).value.trim();
  const descripcion = document.getElementById(`edit_descripcion_${id}`).value.trim();

  if(nombre.length === 0 || nombre.length > 45){
    alert("El nombre debe tener entre 1 y 45 caracteres.");
    return false;
  }

  if(descripcion.length === 0 || descripcion.length > 145){
    alert("La descripción debe tener entre 1 y 145 caracteres.");
    return false;
  }

  return true;
}

function validarAsignar(id){
  const empleado = document.getElementById(`assign_empleado_${id}`).value;
  const horas = document.getElementById(`assign_horas_${id}`).value;
  const fechaInicio = document.getElementById(`assign_fecha_inicio_${id}`).value;
  const fechaFin = document.getElementById(`assign_fecha_fin_${id}`).value;

  if(!empleado){
    alert("Debe seleccionar un empleado.");
    return false;
  }

  if(!horas || horas <= 0 || !Number.isInteger(parseFloat(horas))){
    alert("Las horas asignadas deben ser un número entero positivo.");
    return false;
  }

  if(!fechaInicio || !fechaFin){
    alert("Debe ingresar ambas fechas.");
    return false;
  }

  if(fechaInicio >= fechaFin){
    alert("La fecha de asignación debe ser anterior a la fecha de entrega.");
    return false;
  }

  return true;
}

function validarEditarAsignacion(id){
  const empleado = document.getElementById(`edit_asign_empleado_${id}`).value;
  const proyecto = document.getElementById(`edit_asign_proyecto_${id}`).value;
  const horas = document.getElementById(`edit_asign_horas_${id}`).value;
  const fechaInicio = document.getElementById(`edit_asign_fecha_inicio_${id}`).value;
  const fechaFin = document.getElementById(`edit_asign_fecha_fin_${id}`).value;

  if(!empleado){ alert("Seleccione un empleado."); return false; }
  if(!proyecto){ alert("Seleccione un proyecto."); return false; }
  if(!horas || parseInt(horas) <= 0){ alert("Horas deben ser un entero positivo."); return false; }
  if(!fechaInicio || !fechaFin){ alert("Ingrese ambas fechas."); return false; }
  if(fechaInicio >= fechaFin){ alert("La fecha de asignación debe ser anterior a la fecha de entrega."); return false; }
  return true;
}

function validarCrearDepartamento(){
  const nombre = document.getElementById("crear_depart_nombre").value.trim();
  const descripcion = document.getElementById("crear_depart_descripcion").value.trim();
  if(nombre.length === 0 || nombre.length > 45){
    alert("El nombre debe tener entre 1 y 45 caracteres.");
    return false;
  }
  if(descripcion.length === 0 || descripcion.length > 145){
    alert("La descripción debe tener entre 1 y 145 caracteres.");
    return false;
  }
  return true;
}

function validarEditarDepartamento(id){
  const nombre = document.getElementById(`edit_depart_nombre_${id}`).value.trim();
  const descripcion = document.getElementById(`edit_depart_descripcion_${id}`).value.trim();
  if(nombre.length === 0 || nombre.length > 45){
    alert("El nombre debe tener entre 1 y 45 caracteres.");
    return false;
  }
  if(descripcion.length === 0 || descripcion.length > 145){
    alert("La descripción debe tener entre 1 y 145 caracteres.");
    return false;
  }
  return true;
}

/* ...existing JS functions (filterTable, escapeHtml, etc.) ... */

function filterTable(type){
  const searchInput = document.getElementById(`search-${type}`).value.toLowerCase();
  const rows = document.querySelectorAll(`#${type}-tbody tr`);
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchInput) ? '' : 'none';
  });
}

// utility to avoid XSS when inserting text into templates
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]); });
}
function escapeAttr(s){ return escapeHtml(s); }

</script>

{% endblock %}