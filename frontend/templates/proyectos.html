{% extends "base.html" %}
{% block content %}

<h1>Gestión de Proyectos</h1>

<div class="acciones-superior">
    <button class="btn-primary" onclick="toggleProyectoForm()">+ Nuevo Proyecto</button>
</div>

<!-- FORMULARIO CREAR PROYECTO -->
<div id="formulario-proyecto" class="form-container" style="display:none;">
    <h2>Crear Proyecto</h2>

    <form action="{{ url_for('proyectos.crear_proyecto') }}" method="POST">

        <label>Nombre del proyecto:</label>
        <input type="text" name="nombre" placeholder="Proyecto Alpha" required>

        <label>Descripción:</label>
        <textarea name="descripcion" placeholder="Descripción del proyecto..."></textarea>

        <br>
        <button type="submit" class="btn-primary">Guardar</button>
        <br>
        <button type="button" class="btn-secondary" onclick="toggleProyectoForm()">Cancelar</button>
    </form>
</div>


<hr>

<h2>Proyectos registrados</h2>

<table>
    <tr>
        <th>ID</th>
        <th>Proyecto</th>
        <th>Descripción</th>
        <th>Acciones</th>
    </tr>

    {% for p in proyectos %}
    <tr>
        <td>{{ p.id_proyecto }}</td>
        <td>{{ p.nombre }}</td>
        <td>{{ p.descripcion }}</td>
        <td style="width:220px;">
            <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
                <!-- BOTÓN EDITAR -->
                <button class="btn-secondary"onclick="toggleEditar({{ p.id_proyecto }})" style="padding:0 8px;">
                    Editar
                </button>

                <!-- BOTÓN ASIGNAR EMPLEADO -->
                <button class="btn-primary"onclick="toggleAsignar({{ p.id_proyecto }})" style="padding:0 8px;">
                    Asignar empleado
                </button>

                <!-- ELIMINAR -->
                <form action="{{ url_for('proyectos.eliminar_proyecto', id=p.id_proyecto) }}"
                    method="POST" style="display:inline;" style="margin:0;">
                    <button class="btn-danger" onclick="return confirm('¿Eliminar proyecto?')" style="background:#007bff;border-color:#007bff;padding:6px 18px;border-radius:6px;color:#fff;">
                        Eliminar
                    </button>
            </div>
            </form>
        </td>
    </tr>

    <!-- FORMULARIO EDITAR -->
    <tr id="editar-{{ p.id_proyecto }}" style="display:none;">
        <td colspan="4">
            <div class="form-container" style="margin-top:15px;">

                <h2>Editar Proyecto</h2>

                <form action="{{ url_for('proyectos.actualizar_proyecto', id=p.id_proyecto) }}"
                    method="POST">

                    <label>Nombre del proyecto:</label>
                    <input type="text" name="nombre" value="{{ p.nombre }}" required>

                    <label>Descripción:</label>
                    <textarea name="descripcion">{{ p.descripcion }}</textarea>

                    <br>
                    <button type="submit" class="btn-primary">Guardar cambios</button>
                    <br>
                    <button type="button" class="btn-secondary"
                            onclick="toggleEditar({{ p.id_proyecto }})">Cancelar</button>
                </form>
            </div>
        </td>
    </tr>


    <!-- FORMULARIO ASIGNAR EMPLEADO -->
    <tr id="asignar-{{ p.id_proyecto }}" style="display:none;">
        <td colspan="4">
            <div class="form-container" style="margin-top:15px;">

                <h2>Asignar empleado a: {{ p.nombre }}</h2>

                <form action="{{ url_for('proyectos.asignar_empleado') }}" method="POST">

                    <input type="hidden" name="id_proyecto" value="{{ p.id_proyecto }}">

                    <label>Empleado:</label>
                    <select name="id_empleado" required>
                        <option value="">Seleccione un empleado</option>
                        {% for e in empleados %}
                            <option value="{{ e.id_empleado }}">{{ e.nombre_completo }}</option>
                        {% endfor %}
                    </select>

                    <label>Horas asignadas:</label>
                    <input type="number" name="horas_asignadas" min="1" required>

                    <label>Fecha asignación:</label>
                    <input type="date" name="fecha_asignacion" required>

                    <label>Fecha entrega:</label>
                    <input type="date" name="fecha_entrega" required>

                    <br>
                    <button type="submit" class="btn-primary">Asignar</button>
                    <br>
                    <button type="button" class="btn-secondary"
                            onclick="toggleAsignar({{ p.id_proyecto }})">Cancelar</button>

                </form>
            </div>
        </td>
    </tr>



    {% endfor %}
</table>

<script>
function toggleEditar(id) {
    const row = document.getElementById("editar-" + id);
    row.style.display = row.style.display === "none" ? "table-row" : "none";
}

function toggleAsignar(id) {
    const row = document.getElementById("asignar-" + id);
    row.style.display = row.style.display === "none" ? "table-row" : "none";
}

function toggleProyectoForm() {
    const form = document.getElementById("formulario-proyecto");
    form.style.display = (form.style.display === "none" || form.style.display === "") 
        ? "block" 
        : "none";
}
</script>

{% endblock %}